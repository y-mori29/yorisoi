<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>よりそい 診察メモLIFF</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root {
    --primary-color: #3882F6; /* やさしい青 */
    --danger-color: #EF4444; /* はっきりした赤 */
    --secondary-color: #6B7280;
    --bg-light: #F9FAFB;
    --bg-app: #F3F4F6;
    --text-dark: #1F2937;
    --text-light: #ffffff;
    --border-color: #E5E7EB;
    --green-light: #ECFDF5;
    --green-dark: #065F46;
  }
  
  /* 基本設定 */
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: var(--bg-app);
    margin: 0;
    padding: 16px;
    color: var(--text-dark);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    box-sizing: border-box;
  }

  .container {
    width: 100%;
    max-width: 480px;
    background-color: var(--text-light);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 24px;
    box-sizing: border-box;
  }

  /* ヘッダー */
  header {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
  }

  p, li {
    line-height: 1.7;
    color: #4B5563;
  }

  .hidden {
    display: none;
  }
  
  /* ボタン */
  button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    margin: 16px 0 8px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    color: var(--text-light);
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  button svg {
    width: 20px;
    height: 20px;
  }

  button:not(:disabled):hover { opacity: 0.9; }
  button:not(:disabled):active { transform: scale(0.98); }
  button:disabled {
    background-color: #D1D5DB;
    cursor: not-allowed;
    box-shadow: none;
  }

  #startBtn { background-color: var(--primary-color); }
  #stopBtn { background-color: var(--danger-color); }
  #refreshHistory { background-color: var(--secondary-color); }

  /* --- recordView 専用スタイル --- */
  .instructions {
    text-align: center;
    padding: 0 10px;
  }
  .instructions p {
    font-size: 16px;
    margin-bottom: 24px;
  }
  .steps {
    list-style: none;
    padding: 0;
    margin: 24px 0;
    text-align: left;
  }
  .steps li {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    font-size: 15px;
  }
  .steps li span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: 12px;
    font-size: 14px;
  }
  .result-info {
    background-color: var(--green-light);
    color: var(--green-dark);
    padding: 12px;
    border-radius: 8px;
    font-weight: 500;
    margin-top: 24px;
  }

  /* ステータス表示 */
  #statusArea {
    margin-top: 16px;
    text-align: center;
  }
  #statusArea p { font-size: 16px; font-weight: 500; }
  .pulsing-indicator { display: none; }

  /* メモ作成中のスタイル */
  #recordView.is-active .instructions,
  #recordView.is-active .initial-info {
    display: none;
  }
  #recordView.is-active .pulsing-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    height: 200px;
  }
  .pulsing-indicator .circle {
    width: 80px;
    height: 80px;
    background-color: var(--primary-color);
    border-radius: 50%;
    animation: pulse 2s infinite ease-in-out;
  }
  @keyframes pulse {
    0% { transform: scale(0.9); opacity: 0.7; }
    50% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.9); opacity: 0.7; }
  }
  .warn-iphone {
    background-color: #FFFBEB;
    border: 1px solid #FDE68A;
    border-radius: 8px;
    padding: 12px;
    color: #92400E;
    margin-top: 24px;
  }
  
  /* 履歴ビュー */
  #historyList {
    list-style: none; padding: 0; margin-top: 16px;
  }
  #historyList li {
    background-color: var(--bg-light); padding: 12px; border-radius: 8px;
    margin-bottom: 8px; border-left: 4px solid var(--primary-color);
  }

  /* ヘルプビュー */
  #helpView h3 {
    font-size: 18px; margin-top: 20px; margin-bottom: 10px;
    border-left: 4px solid var(--primary-color); padding-left: 8px;
  }
  #helpView ol { padding-left: 20px; }
  .warn {
    background-color: #fffbe6; border: 1px solid #ffe58f;
    border-radius: 6px; padding: 12px; color: #8a6d3b; margin-top: 16px;
  }

  /* ログ表示エリア */
  #log {
    white-space: pre-wrap; background: #282c34; color: #abb2bf;
    padding: 12px; border-radius: 6px; margin-top: 24px;
    font-family: 'Menlo', 'Consolas', monospace; font-size: 12px;
    max-height: 150px; overflow-y: auto; word-break: break-all;
  }
</style>
</head>
<body>
  <div class="container">
    <header id="title">おまかせ診察メモ</header>

    <div id="tabs">
      <div id="recordView" class="hidden">
        <div class="instructions">
            <p>医師との大切な会話を、後から振り返れるメモにします。</p>
            <ol class="steps">
                <li><span>1.</span>下の「おまかせメモをはじめる」ボタンを押す</li>
                <li><span>2.</span>診察中はスマホを置いたままでOKです</li>
                <li><span>3.</span>診察が終わったら「完了する」ボタンを押す</li>
            </ol>
            <p class="result-info">しばらくすると、LINEに要約が届きます。</p>
        </div>

        <div id="statusArea">
          <div class="pulsing-indicator">
            <div class="circle"></div>
            <p id="statusText">お話をきいています...</p>
          </div>
          <div class="warn-iphone hidden">
              <p><strong>iPhoneをご利用の方へ</strong></p>
              <p>メモ作成中は画面をロックせず、この画面を表示したままにしてください。</p>
          </div>
          <p class="initial-info">準備完了</p>
          <div id="download"></div>
        </div>

        <button id="startBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
            <span>おまかせメモをはじめる</span>
        </button>
        <button id="stopBtn" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M6 18h12V6H6v12zM8 8h8v8H8V8z"></path></svg>
            <span>完了する</span>
        </button>
      </div>

      <div id="historyView" class="hidden">
        <p>過去の診察メモ履歴です。</p>
        <ul id="historyList"></ul>
        <button id="refreshHistory">更新</button>
      </div>

      <div id="helpView" class="hidden">
        <h3>使い方</h3>
        <ol>
          <li>「おまかせメモをはじめる」ボタンでメモ作成を開始します。</li>
          <li>診察が終わったら「完了する」ボタンで終了します。</li>
          <li>処理が終わると、まとめがLINEに届きます。</li>
        </ol>
        <p class="warn">iPhoneでは画面を閉じるとメモ作成が止まります。作成中は画面を開いたままにしてください。</p>
      </div>
    </div>

    <div id="log"></div>
  </div>

<script>
/* --- 設定 (必要に応じて置き換えてください) --- */
const LIFF_ID = "2008082630-ry2J7971";
const USE_UPLOAD = true;
const UPLOAD_URL = "https://98cbe348b922.ngrok-free.app/upload-chunk";
const FINISH_URL  = "https://yorisoi-api-774008321836.asia-northeast1.run.app/manual-upload";
const HISTORY_URL = "https://98cbe348b922.ngrok-free.app/history";

/* --- UI elements --- */
const el = id => document.getElementById(id);
const log = (s) => { 
  el('log').textContent += s + "\n";
  el('log').scrollTop = el('log').scrollHeight;
}

/* --- タブ判定 --- */
function getTab() {
  const p = new URLSearchParams(location.search);
  return (p.get('tab') || 'record').toLowerCase();
}

/* --- LIFF 初期化 --- */
async function initLiffAndRoute() {
  try {
    await liff.init({ liffId: LIFF_ID });
    log('LIFF initialized');
    if (!liff.isLoggedIn()) {
      log('ログインしていません → ログインします');
      liff.login();
      return;
    }
    log('ログイン済み');
    routeTab(getTab());
  } catch (e) { log('LIFF 初期化エラー: ' + e); }
}

/* --- タブ表示 --- */
function hideAll() {
  ['recordView','historyView','helpView'].forEach(id => el(id).classList.add('hidden'));
}
function routeTab(tab) {
  hideAll();
  if (tab === 'record') {
    el('title').textContent = 'おまかせ診察メモ';
    el('recordView').classList.remove('hidden');
  } else if (tab === 'history') {
    el('title').textContent = '過去のメモ';
    el('historyView').classList.remove('hidden');
    loadHistory();
  } else {
    el('title').textContent = '使い方';
    el('helpView').classList.remove('hidden');
  }
}

/* --- メモ作成ロジック（MediaRecorder） --- */
let stream = null, recorder = null, sessionId = null, seq = 0, chunks = [];

function isIphone() {
  return /iPhone/.test(navigator.userAgent);
}

function pickMime() {
  const cand = ['audio/webm;codecs=opus','audio/webm','audio/mp4','video/mp4'];
  for (const t of cand) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
  }
  return '';
}

async function startRec() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mime = pickMime();
    recorder = mime ? new MediaRecorder(stream, { mimeType: mime }) : new MediaRecorder(stream);
    sessionId = crypto.randomUUID();
    seq = 0; chunks = [];
    
    el('recordView').classList.add('is-active');
    el('download').textContent = '';
    if (isIphone()) {
      el('statusArea').querySelector('.warn-iphone').classList.remove('hidden');
    }
    el('startBtn').disabled = true;
    el('stopBtn').disabled = false;

    recorder.ondataavailable = async (ev) => {
      if (!ev.data || ev.data.size === 0) return;
      if (USE_UPLOAD) await uploadChunk(ev.data);
      else chunks.push(ev.data);
    };
    recorder.onerror = e => log('マイクエラー:' + e);
    recorder.start(5000); // 5秒チャンク
    log('メモ作成開始: mime=' + (recorder.mimeType || 'default'));
  } catch (err) {
    log('マイクの利用許可が必要です: ' + err);
    alert('マイクの利用を許可してください。');
  }
}

async function stopRec() {
  try {
    if (recorder && recorder.state !== 'inactive') recorder.stop();
    stream && stream.getTracks().forEach(t=>t.stop());

    el('recordView').classList.remove('is-active');
    el('statusArea').querySelector('.warn-iphone').classList.add('hidden');
    el('startBtn').disabled = false;
    el('stopBtn').disabled = true;
    
    if (USE_UPLOAD) {
      const idToken = liff.getIDToken() || '';
      await fetch(FINISH_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, idToken }) });
      log('finish通知 送信済');
      el('download').textContent = 'メモを整理してLINEに送信しました。';
    } else {
      const type = pickMime() || (chunks[0]?.type || 'audio/webm');
      const blob = new Blob(chunks, { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `yorisoi-memo-${new Date().toISOString().replace(/[:.]/g,'-')}.${type.includes('mp4')?'mp4':'webm'}`;
      a.textContent = 'メモデータをダウンロード';
      const dlContainer = el('download');
      dlContainer.innerHTML = '';
      dlContainer.appendChild(a);
      log('ローカル保存モード: 作成停止');
    }
  } catch (e) { log('停止エラー:' + e); }
}

async function uploadChunk(blob) {
  seq++;
  const fd = new FormData();
  fd.append('sessionId', sessionId);
  fd.append('seq', String(seq));
  fd.append('blob', blob, `chunk-${seq}.bin`);
  fd.append('idToken', liff.getIDToken() || '');
  try {
  const res = await fetch(UPLOAD_URL, { method:'POST', body: fd });
    if (!res.ok) throw new Error(await res.text());
    log('chunk uploaded seq=' + seq);
  } catch (e) { log('chunk upload error: ' + e); }
}

/* --- 履歴取得 --- */
async function loadHistory() {
  try {
    el('historyList').innerHTML = '<li>読み込み中…</li>';
    const prof = await liff.getProfile();
    const userId = prof.userId;
    const res = await fetch(HISTORY_URL + '?userId=' + encodeURIComponent(userId));
    if (!res.ok) throw new Error(await res.text());
    const items = await res.json();
    if (!Array.isArray(items) || items.length === 0) { 
      el('historyList').innerHTML = '<li>過去のメモはありません</li>'; 
      return; 
    }
    el('historyList').innerHTML = '';
    items.forEach(it => {
      const li = document.createElement('li');
      li.textContent = `${it.date || ''} — ${it.title || it.summary || ''}`;
      el('historyList').appendChild(li);
    });
    log('履歴読み込み: ' + items.length + ' 件');
  } catch (e) {
    el('historyList').innerHTML = '<li>履歴取得エラー</li>';
    log('history load error: ' + e);
  }
}

/* --- イベント割当 --- */
document.addEventListener('DOMContentLoaded', () => {
  el('startBtn').onclick = startRec;
  el('stopBtn').onclick = stopRec;
  el('refreshHistory').onclick = loadHistory;
  initLiffAndRoute();
});
</script>
</body>
</html>




